# Template: v1.2
# {{RULE_NAME}}

require ["include", "environment", "variables", "relational", "comparator-i;ascii-numeric", "spamtest", "fileinto", "imap4flags", "vnd.proton.expire", "extlists", "reject"];

# Generated: Do not run this script on spam messages
if allof (environment :matches "vnd.proton.spam-threshold" "*", spamtest :value "ge" :comparator "i;ascii-numeric" "${1}") {
    return;
}

# --- GLOBAL RULES ---

# 1. Global | Subject | Default (F) - FileInto
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-default:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-default:matches}}]
) {
  fileinto "{{RULE_NAME}}";
}

# 2. Global | Subject | Read (FR) - FileInto + Seen
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-read:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-read:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
}

# 3. Global | Subject | Read Stop (FRS) - FileInto + Seen + Stop
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-read-stop:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-read-stop:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  stop;
}

# 4. Global | Subject | Archive (FRA) - FileInto + Seen + Archive
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-read-archive:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-read-archive:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  fileinto "archive";
}

# 5. Global | Subject | Archive Stop (FRAS) - FileInto + Seen + Archive + Stop
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-read-archive-stop:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-read-archive-stop:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  fileinto "archive";
  stop;
}

# 6. Global | Subject | Expire (Fx1) - FileInto + Expire
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-expire:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-expire:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  expire "day" "1";
  stop;
}

# 7. Global | Subject | Bounce/Reject (B)
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-reject:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-reject:matches}}]
) {
  reject "This message was rejected by the mail delivery system.";
  stop;
}

# 8. Global | From | Default (F)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-default:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-default:matches}}]
) {
  fileinto "{{RULE_NAME}}";
}

# 9. Global | From | Read Stop (FRS)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-read-stop:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-read-stop:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  stop;
}

# 10. Global | From | Archive (FRA)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-read-archive:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-read-archive:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  fileinto "archive";
}

# 11. Global | From | Archive Stop (FRAS)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-read-archive-stop:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-read-archive-stop:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  fileinto "archive";
  stop;
}

# 12. Global | From | Expire (Fx1)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-expire:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-expire:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  expire "day" "1";
  stop;
}

# 13. Global | From | Bounce/Reject (B)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-reject:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-reject:matches}}]
) {
  reject "This message was rejected by the mail delivery system.";
  stop;
}


# --- SCOPED RULES ---
# Applies only when delivered to: {{RULE_NAME_LOWER}}...
if header :contains "X-Original-To" "{{RULE_NAME_LOWER}}" {

    # 14. Scoped | Subject | Default (!F)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-default:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-default:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
    }

    # 15. Scoped | Subject | Read (!FR)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-read:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-read:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
    }

    # 16. Scoped | Subject | Read Stop (!FRS)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-read-stop:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-read-stop:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      stop;
    }

    # 17. Scoped | Subject | Archive (!FRA)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-read-archive:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-read-archive:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      fileinto "archive";
    }

    # 18. Scoped | Subject | Archive Stop (!FRAS)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-read-archive-stop:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-read-archive-stop:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      fileinto "archive";
      stop;
    }

    # 19. Scoped | Subject | Expire (!Fx1)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-expire:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-expire:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      expire "day" "1";
      stop;
    }

    # 20. Scoped | Subject | Bounce/Reject (!B)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-reject:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-reject:matches}}]
    ) {
      reject "This message was rejected by the mail delivery system.";
      stop;
    }

    # 21. Scoped | From | Default (! from:F)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-default:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-default:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
    }

    # 22. Scoped | From | Read Stop (! from:FRS)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-read-stop:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-read-stop:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      stop;
    }

    # 23. Scoped | From | Archive (! from:FRA)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-read-archive:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-read-archive:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      fileinto "archive";
    }

    # 24. Scoped | From | Archive Stop (! from:FRAS)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-read-archive-stop:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-read-archive-stop:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      fileinto "archive";
      stop;
    }

    # 25. Scoped | From | Expire (! from:Fx1)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-expire:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-expire:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      expire "day" "1";
      stop;
    }

    # 26. Scoped | From | Bounce/Reject (! from:B)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-reject:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-reject:matches}}]
    ) {
      reject "This message was rejected by the mail delivery system.";
      stop;
    }
}
