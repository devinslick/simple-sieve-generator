# Template: v1.1
# {{RULE_NAME}}

require ["include", "environment", "variables", "relational", "comparator-i;ascii-numeric", "spamtest", "fileinto", "imap4flags", "vnd.proton.expire", "extlists", "reject"];

# Generated: Do not run this script on spam messages
if allof (environment :matches "vnd.proton.spam-threshold" "*", spamtest :value "ge" :comparator "i;ascii-numeric" "${1}") {
    return;
}

# --- GLOBAL RULES ---

# 1. Global | Subject | Default (F) - FileInto
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-default:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-default:matches}}]
) {
  fileinto "{{RULE_NAME}}";
}

# 2. Global | Subject | Seen (FS) - FileInto + Seen
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-seen:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-seen:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
}

# 3. Global | Subject | Seen Stop (FSS) - FileInto + Seen + Stop
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-seen-stop:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-seen-stop:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  stop;
}

# 4. Global | Subject | Archive (FSA) - FileInto + Seen + Archive
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-seen-archive:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-seen-archive:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  fileinto "archive";
}

# 5. Global | Subject | Archive Stop (FSAS) - FileInto + Seen + Archive + Stop
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-seen-archive-stop:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-seen-archive-stop:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  fileinto "archive";
  stop;
}

# 6. Global | Subject | Expire (Fx1) - FileInto + Expire
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-expire:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-expire:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  expire "day" "1";
  stop;
}

# 7. Global | Subject | Reject (R)
if anyof (
  header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:global-subject-reject:contains}}],
  header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:global-subject-reject:matches}}]
) {
  reject "This message was rejected by the {{RULE_NAME}} filter.";
  stop;
}

# 8. Global | From | Default (F)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-default:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-default:matches}}]
) {
  fileinto "{{RULE_NAME}}";
}

# 9. Global | From | Seen Stop (FSS)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-seen-stop:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-seen-stop:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  stop;
}

# 10. Global | From | Archive (FSA)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-seen-archive:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-seen-archive:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  fileinto "archive";
}

# 11. Global | From | Archive Stop (FSAS)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-seen-archive-stop:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-seen-archive-stop:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  addflag "\\Seen";
  fileinto "archive";
  stop;
}

# 12. Global | From | Expire (Fx1)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-expire:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-expire:matches}}]
) {
  fileinto "{{RULE_NAME}}";
  expire "day" "1";
  stop;
}

# 13. Global | From | Reject (R)
if anyof (
  address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:global-from-reject:contains}}],
  address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:global-from-reject:matches}}]
) {
  reject "This message was rejected by the {{RULE_NAME}} filter.";
  stop;
}


# --- SCOPED RULES ---
# Applies only when delivered to: {{RULE_NAME_LOWER}}...
if header :contains "X-Original-To" "{{RULE_NAME_LOWER}}" {

    # 14. Scoped | Subject | Default (!F)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-default:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-default:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
    }

    # 15. Scoped | Subject | Seen (!FS)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-seen:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-seen:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
    }

    # 16. Scoped | Subject | Seen Stop (!FSS)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-seen-stop:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-seen-stop:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      stop;
    }

    # 17. Scoped | Subject | Archive (!FSA)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-seen-archive:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-seen-archive:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      fileinto "archive";
    }

    # 18. Scoped | Subject | Archive Stop (!FSAS)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-seen-archive-stop:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-seen-archive-stop:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      fileinto "archive";
      stop;
    }

    # 19. Scoped | Subject | Expire (!Fx1)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-expire:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-expire:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      expire "day" "1";
      stop;
    }

    # 20. Scoped | Subject | Reject (!R)
    if anyof (
      header :comparator "i;unicode-casemap" :contains "Subject" [{{LIST:scoped-subject-reject:contains}}],
      header :comparator "i;unicode-casemap" :matches "Subject" [{{LIST:scoped-subject-reject:matches}}]
    ) {
      reject "This message was rejected by the {{RULE_NAME}} filter.";
      stop;
    }

    # 21. Scoped | From | Default (! from:F)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-default:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-default:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
    }

    # 22. Scoped | From | Seen Stop (! from:FSS)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-seen-stop:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-seen-stop:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      stop;
    }

    # 23. Scoped | From | Archive (! from:FSA)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-seen-archive:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-seen-archive:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      fileinto "archive";
    }

    # 24. Scoped | From | Archive Stop (! from:FSAS)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-seen-archive-stop:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-seen-archive-stop:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      addflag "\\Seen";
      fileinto "archive";
      stop;
    }

    # 25. Scoped | From | Expire (! from:Fx1)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-expire:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-expire:matches}}]
    ) {
      fileinto "{{RULE_NAME}}";
      expire "day" "1";
      stop;
    }

    # 26. Scoped | From | Reject (! from:R)
    if anyof (
      address :all :comparator "i;unicode-casemap" :contains ["From"] [{{LIST:scoped-from-reject:contains}}],
      address :all :comparator "i;unicode-casemap" :matches ["From"] [{{LIST:scoped-from-reject:matches}}]
    ) {
      reject "This message was rejected by the {{RULE_NAME}} filter.";
      stop;
    }
}
